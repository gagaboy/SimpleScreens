<?xml version="1.0" encoding="UTF-8"?>
<!--
This software is in the public domain under CC0 1.0 Universal plus a
Grant of Patent License.

To the extent possible under law, the author(s) have dedicated all
copyright and related and neighboring rights to this software to the
public domain worldwide. This software is distributed without any
warranty.

You should have received a copy of the CC0 Public Domain Dedication
along with this software (see the LICENSE.md file). If not, see
<http://creativecommons.org/publicdomain/zero/1.0/>.
-->
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/xml-screen-2.1.xsd"
        default-menu-title="Pack Shipment" default-menu-include="false">

    <parameter name="shipmentId" required="true"/>

    <transition name="shipmentDetail"><default-response url="//${appRoot}/Shipment/ShipmentDetail"/></transition>

    <transition name="orderDetail"><default-response url="//${appRoot}/Order/OrderDetail"/></transition>
    <transition name="editInvoice"><default-response url="//${appRoot}/Accounting/Invoice/EditInvoice"/></transition>
    <transition name="editPayment"><default-response url="//${appRoot}/Accounting/Payment/EditPayment"/></transition>
    <transition name="editTransaction"><default-response url="//${appRoot}/Accounting/Transaction/EditTransaction"/></transition>
    <transition name="assetDetail"><default-response url="//${appRoot}/Asset/AssetDetail"/></transition>
    <transition name="picklistDetail"><default-response url="//${appRoot}/Picking/PicklistDetail"/></transition>

    <transition name="editFacility"><default-response url="//${appRoot}/Facility/EditFacility"/></transition>
    <transition name="editParty"><default-response url="//${appRoot}/Party/EditParty"/></transition>
    <transition name="editSupplier"><default-response url="//${appRoot}/Supplier/EditSupplier"/></transition>
    <transition name="editCustomer"><default-response url="//${appRoot}/Customer/EditCustomer"/></transition>

    <transition name="updateItem"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentItem"/>
        <default-response url="."/></transition>
    <transition name="packShipmentProduct"><service-call name="mantle.shipment.ShipmentServices.pack#ShipmentProduct"/>
        <default-response url="."/></transition>
    <transition name="packShipmentProductScan"><service-call name="mantle.shipment.ShipmentServices.pack#ShipmentProductScan"/>
        <default-response url="."/></transition>
    <transition name="unpackItemIssuance"><service-call name="mantle.shipment.ShipmentServices.unpack#ShipmentItemIssuance"/>
        <default-response url="."/></transition>

    <transition name="updatePackageAndRouteSeg"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentPackageAndRouteSeg"/>
        <default-response url="."/></transition>
    <transition name="addItemToPackage"><service-call name="mantle.shipment.ShipmentServices.add#ItemToPackage"/>
        <default-response url="."/></transition>
    <transition name="updatePackageContent"><service-call name="mantle.shipment.ShipmentServices.update#ShipmentPackageContent"/>
        <default-response url="."/></transition>
    <transition name="createShipmentAutoPackages"><service-call name="mantle.shipment.ShipmentServices.create#ShipmentAutoPackages"/>
        <default-response url="."/></transition>

    <transition-include name="getAssetList" location="component://SimpleScreens/template/product/ProductTransitions.xml"/>

    <actions>
        <service-call name="mantle.shipment.ShipmentServices.get#ShipmentDisplayInfo" in-map="[shipmentId:shipmentId]" out-map="context"/>
        <if condition="!isOutgoing &amp;&amp; !isTransfer"><return error="true" message="Shipment ${shipmentId} is not an outgoing or transfer shipment"/></if>

        <set field="defaultNetworkPrinterId" from="ec.user.getPreference('Shipment.networkPrinterId.default')"/>

        <!-- TODO: improve; session maintained active (or first package with no box/weight?) -->
        <set field="activePackageSeqId" from="shipmentPackageList ? shipmentPackageList[0].shipmentPackageSeqId : null"/>
    </actions>
    <widgets>
        <!--
            Usage/Flow
            1. scan item to pack (product or asset barcode; for product also lookup by other IDs like SKU, UPC, etc)
            2. set package info (box type, weight), clear active package so next item scan (if there is one) creates a new package
            3. repeat #1 and #2 as needed
            4. Pack Completed
               - set to packed (create invoice, capture CC)
               - if CC captured get labels for specified carrier/method
               - if got labels and a network printer is selected send to printer
        -->

        <container-row><row-col md="6">
            <container><label text="Pack Shipment "/><link url="shipmentDetail" text="${shipmentId}" link-type="anchor"/></container>
            <!--
                scan input (product or asset ID, other product IDs like SKU/UPC/etc), auto-focused
                quantity input default 1 (with up/down buttons?)
                package drop-down with active package selected
            -->
            <form-single name="PackScanForm" transition="packShipmentProductScan" focus-field="scanInput">
                <field name="shipmentId"><default-field><hidden/></default-field></field>
                <field name="quantity" from="1"><default-field title=""><text-line size="4"/></default-field></field>
                <field name="scanInput"><default-field title=""><text-line size="20"/></default-field></field>
                <field name="shipmentPackageSeqId" from="activePackageSeqId">
                    <default-field title=""><drop-down>
                        <option key="" text="New"/>
                        <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                    </drop-down></default-field>
                </field>
                <field name="packButton"><default-field title="Pack Item"><submit/></default-field></field>
                <field-layout><field-row-big><field-ref name="quantity"/><field-ref name="scanInput"/>
                    <field-ref name="shipmentPackageSeqId"/><field-ref name="packButton"/></field-row-big></field-layout>
            </form-single>

            <!-- close package form, set current package box type and weight; clears active package so next item scan goes in new package -->
            <!-- TODO: don't auto package for this screen, should be store level setting or something; maybe even kill package contents records if there are any? -->

            <!-- warning if payment not authorized -->
            <!-- Pack Completed dialog
                - disabled unless at least one item packed and non-empty packages have box type and weight
                - dynamic dialog, load with carrier/method rates looked up and cheapest for method selected
                - with confirmation mention auto get labels and print, extra text if not fully packed
                - auto select carrier by method selected and rate lookup
                - make sure shipment item quantity and SIS quantity reduced on partial ship
            -->
            <!-- set network printer mini form -->
            <!-- small manual set carrier/method form -->
            <!-- manual Get Labels button and Print Labels dialog -->


            <!-- package list -->
            <!-- switch active package link 'Make Active' -->
            <!-- set box type, weight, tracking code, etc form in dialog -->
            <!-- product/quantity list; move quantity to package form -->
            <section-iterate name="PackageListSection" list="shipmentPackageList" entry="shipmentPackage"><actions>
                <set field="shipmentBoxType" from="shipmentPackage.boxType"/>
                <set field="weightUom" from="shipmentPackage.weightUom"/>
                <set field="shipmentPackageContentList" from="shipmentPackage.contents"/>
                <set field="packageRouteSeg" from="packageRouteSegList.find({ it.shipmentPackageSeqId == shipmentPackage.shipmentPackageSeqId &amp;&amp; it.shipmentRouteSegmentSeqId == firstRouteSegment.shipmentRouteSegmentSeqId })"/>
                <set field="hasLabel" from="packageRouteSeg.gatewayLabelId || packageRouteSeg.labelImage != null || packageRouteSeg.labelUrl"/>
                <set field="hasReturnLabel" from="packageRouteSeg.returnGatewayLabelId || packageRouteSeg.returnLabelImage != null || packageRouteSeg.returnLabelUrl"/>
                <set field="trackingStatusEnum" from="packageRouteSeg?.trackingStatusEnum"/>
                <set field="returnTrackingStatusEnum" from="packageRouteSeg?.returnTrackingStatusEnum"/>
                <script>packageAndRouteSeg = new HashMap(shipmentPackage); packageAndRouteSeg.putAll(packageRouteSeg)</script>
            </actions><widgets>
                <container-box type="warning"><box-header title="Package ${shipmentPackage.shipmentPackageSeqId}"/><box-toolbar>
                    <container-dialog id="UpdatePackageDialog" button-text="Update Package">
                        <form-single name="UpdatePackageForm" map="packageAndRouteSeg" transition="updatePackageAndRouteSeg">
                            <field name="shipmentId"><default-field><hidden/></default-field></field>
                            <field name="shipmentPackageSeqId"><default-field><hidden/></default-field></field>
                            <field name="shipmentRouteSegmentSeqId"><default-field><hidden/></default-field></field>

                            <field name="shipmentBoxTypeId"><default-field title="Box Type">
                                <drop-down allow-empty="true">
                                    <entity-options key="${shipmentBoxTypeId}" text="${description}">
                                        <entity-find entity-name="mantle.shipment.ShipmentBoxType">
                                            <order-by field-name="description"/></entity-find></entity-options>
                                </drop-down>
                            </default-field></field>
                            <field name="weight"><default-field><text-line size="8"/></default-field></field>
                            <field name="weightUomId"><default-field title="Weight UOM">
                                <drop-down allow-empty="true" no-current-selected-key="WT_lb">
                                    <entity-options key="${uomId}" text="${description}">
                                        <entity-find entity-name="moqui.basic.Uom">
                                            <econdition field-name="uomTypeEnumId" value="UT_WEIGHT_MEASURE"/>
                                            <order-by field-name="description"/></entity-find></entity-options>
                                </drop-down>
                            </default-field></field>
                            <field name="trackingCode"><default-field><text-line size="30"/></default-field></field>
                            <!-- <field name="boxNumber"><default-field><text-line size="8"/></default-field></field> -->
                            <field name="estimatedAmount"><default-field title="Est. Cost"><text-line size="10"/></default-field></field>

                            <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                        </form-single>
                    </container-dialog>

                    <link url="requestShipmentLabels" text="Get Label"
                            condition="shippingGatewayConfigId &amp;&amp; !hasLabel &amp;&amp; destContactMechValid"
                            parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                    <container-dialog id="RequestPkgLabelDialog" button-text="Get Label" type="warning"
                            condition="shippingGatewayConfigId &amp;&amp; !hasLabel &amp;&amp; !destContactMechValid">
                        <label text="Warning: destination address is incomplete or invalid according to address validation." style="text-warning"/>
                        <link url="requestShipmentLabels" text="Get Label Anyway"
                                parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                    shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                    </container-dialog>

                    <container-dialog id="RequestRetLabelDialog" button-text="Get Return Label"
                            condition="shippingGatewayConfigId &amp;&amp; hasLabel &amp;&amp; !hasReturnLabel">
                        <form-single name="RequestRetLabel" transition="requestShipmentLabels">
                            <field name="shipmentId"><default-field><hidden/></default-field></field>
                            <field name="shipmentPackageSeqId" from="shipmentPackage.shipmentPackageSeqId">
                                <default-field><hidden/></default-field></field>
                            <field name="shipmentRouteSegmentSeqId" from="packageRouteSeg.shipmentRouteSegmentSeqId">
                                <default-field><hidden/></default-field></field>
                            <field name="getReturnLabels" from="'true'"><default-field><hidden/></default-field></field>
                            <field name="shipmentMethodEnumId" from="firstRouteSegment.shipmentMethodEnumId"><default-field title="Return By"><drop-down>
                                <entity-options key="${shipmentMethodEnumId}" text="${description}">
                                    <entity-find entity-name="mantle.shipment.carrier.CarrierShipmentMethod" list="carrierShipmentMethods">
                                        <econdition field-name="carrierPartyId" from="firstRouteSegment.carrierPartyId"/>
                                        <order-by field-name="sequenceNum,description"/></entity-find>
                                </entity-options>
                            </drop-down></default-field></field>
                            <field name="submitButton"><default-field title="Get Return Label"><submit/></default-field></field>
                        </form-single>
                    </container-dialog>

                    <link url="refundShipmentLabels" text="Refund Label" style="btn-danger"
                            confirmation="Request refund? If package has not yet shipped a refund will be processed and label will not be valid for shipping."
                            condition="shippingGatewayConfigId &amp;&amp; packageRouteSeg?.gatewayLabelId &amp;&amp; !packageRouteSeg?.gatewayRefundId"
                            parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                    <link url="removeShipmentLabelInfo" text="Clear Label Info" style="btn-danger"
                            confirmation="Clear label data? This will allow getting a new label, and system keeps a history of label IDs, but otherwise current label will no longer be tracked. Use only when there are errors, etc with the label."
                            condition="shippingGatewayConfigId &amp;&amp; packageRouteSeg?.gatewayLabelId"
                            parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                    <link url="removeShipmentReturnLabelInfo" text="Clear Ret Label Info" style="btn-danger"
                            confirmation="Clear return label data? This will allow getting a new label, and system keeps a history of label IDs, but otherwise current label will no longer be tracked. Use only when there are errors, etc with the label."
                            condition="shippingGatewayConfigId &amp;&amp; packageRouteSeg?.returnGatewayLabelId"
                            parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                    <link url="deletePackage" text="Delete Package" condition="!shipmentPackageContentList" style="btn-danger"
                            confirmation="Delete package ${shipmentPackage.shipmentPackageSeqId}?"
                            parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId]"/>

                    <link url="trackShipmentLabels" text="Track" style="btn-warning"
                            condition="shippingGatewayConfigId &amp;&amp; packageRouteSeg?.gatewayLabelId"
                            parameter-map="[shipmentId:shipmentId, shipmentPackageSeqId:shipmentPackage.shipmentPackageSeqId,
                                shipmentRouteSegmentSeqId:packageRouteSeg.shipmentRouteSegmentSeqId]"/>
                    <link url="${packageRouteSeg.trackingUrl}" text="Carrier Track" url-type="plain" target-window="_blank"
                            style="btn-warning" condition="packageRouteSeg?.trackingUrl"/>
                    <link url="${packageRouteSeg.returnTrackingUrl}" text="Carrier Ret Track" url-type="plain" style="btn-info"
                            target-window="_blank" condition="packageRouteSeg?.returnTrackingUrl"/>

                    <link url="${packageRouteSeg.labelUrl}" text="Download Label" url-type="plain" target-window="_blank"
                            style="btn-success" condition="packageRouteSeg?.labelUrl"/>
                    <link url="${packageRouteSeg.returnLabelUrl}" text="Download Ret Label" url-type="plain" target-window="_blank"
                            style="btn-info" condition="packageRouteSeg?.returnLabelUrl"/>
                    <container-dialog id="PrintLabelDialog" button-text="Print Label" type="success"
                            condition="packageRouteSeg?.labelUrl || packageRouteSeg?.labelImage != null">
                        <form-single name="PrintShipmentLabel" transition="printShipmentLabels">
                            <field name="shipmentId"><default-field><hidden/></default-field></field>
                            <field name="shipmentPackageSeqId" from="shipmentPackage.shipmentPackageSeqId">
                                <default-field><hidden/></default-field></field>
                            <field name="shipmentRouteSegmentSeqId" from="packageRouteSeg.shipmentRouteSegmentSeqId">
                                <default-field><hidden/></default-field></field>
                            <field name="networkPrinterId" from="defaultNetworkPrinterId"><default-field title="Printer"><drop-down>
                                <entity-options key="${networkPrinterId}" text="${description ?: printerName} (${serverHost})">
                                    <entity-find entity-name="moqui.basic.print.NetworkPrinter">
                                        <order-by field-name="description,printerName"/></entity-find></entity-options>
                            </drop-down></default-field></field>
                            <field name="makeDefaultPrinter"><default-field title="Make Default"><check><option key="true" text=" "/></check></default-field></field>
                            <field name="returnLabels"><default-field title=""><radio no-current-selected-key="false">
                                <option key="false" text="Outgoing Labels"/><option key="true" text="Return Labels"/></radio></default-field></field>
                            <field name="submitButton"><default-field title="Print"><submit/></default-field></field>
                        </form-single>
                    </container-dialog>
                </box-toolbar><box-body>
                    <container-row>
                        <row-col sm="1"><label text="Status" type="strong"/></row-col>
                        <row-col sm="2"><label text="${trackingStatusEnum?.description?:'N/A'}${packageRouteSeg.trackingSubStatus ? ' (' + packageRouteSeg.trackingSubStatus + ')' : ''}"/></row-col>
                        <row-col sm="1"><label text="Box" type="strong"/></row-col>
                        <row-col sm="4"><label text="${shipmentBoxType?.description?:'N/A'} - ${ec.l10n.format(shipmentPackage.weight, null)?:'N/A'} ${weightUom?.description?:''}" style="text-info"/></row-col>
                        <row-col sm="1"><label text="Tracking" type="strong"/></row-col>
                        <row-col sm="3"><label text="${packageRouteSeg?.trackingCode?:'N/A'}" type="div"/></row-col>
                    </container-row>
                    <container-row>
                        <row-col sm="1"><label text="ETA" type="strong"/></row-col>
                        <row-col sm="2"><label text="${packageRouteSeg?.trackingEta ? ec.l10n.format(packageRouteSeg.trackingEta, null) : 'N/A'}"
                                style="${packageRouteSeg?.trackingEta &lt;= packageRouteSeg?.trackingOrigEta ? 'text-success' : 'text-warning'}"/></row-col>
                        <row-col sm="1"><label text="Orig. ETA" type="strong"/></row-col>
                        <row-col sm="2"><label text="${packageRouteSeg?.trackingOrigEta ? ec.l10n.format(packageRouteSeg.trackingOrigEta, null) : 'N/A'}"/></row-col>

                        <row-col sm="1"><label text="Label ID" type="strong"/></row-col>
                        <row-col sm="3"><label text="${packageRouteSeg?.gatewayLabelId?:'N/A'}"/></row-col>
                        <!--
                        <row-col sm="1"><label text="Rate ID" type="strong"/></row-col>
                        <row-col sm="3"><label text="${packageRouteSeg?.gatewayRateId?:'N/A'}"/></row-col>
                        -->
                        <row-col sm="1"><label text="Amount" type="strong"/></row-col>
                        <row-col sm="1"><label text="${ec.l10n.format(packageRouteSeg?.estimatedAmount, '#,##0.00')}" style="text-success"/></row-col>
                    </container-row>
                    <container-row>
                        <row-col sm="1"><label text="Gateway" type="strong"/></row-col>
                        <row-col sm="2"><label text="${packageRouteSeg?.gatewayStatus?:'N/A'}"/></row-col>
                        <row-col sm="1"><label text="Message" type="strong"/></row-col>
                        <row-col sm="8"><label text="${packageRouteSeg?.gatewayMessage?:'N/A'}"/></row-col>
                    </container-row>
                    <section name="LabelRefundSection" condition="packageRouteSeg?.gatewayRefundId"><widgets>
                        <container-row>
                            <row-col sm="1"><label text="Refund" type="strong"/></row-col>
                            <row-col sm="1"><label text="${packageRouteSeg?.gatewayRefundStatus?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Refund ID" type="strong"/></row-col>
                            <row-col sm="3"><label text="${packageRouteSeg?.gatewayRefundId?:'N/A'}"/></row-col>
                        </container-row>
                    </widgets></section>
                    <section name="LabelReturnSection" condition="hasReturnLabel"><widgets>
                        <container-row>
                            <row-col sm="1"><label text="Ret Status" type="strong"/></row-col>
                            <row-col sm="1"><label text="${returnTrackingStatusEnum?.description?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Ret Message" type="strong"/></row-col>
                            <row-col sm="5"><label text="${packageRouteSeg?.returnGatewayMessage?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Ret Tracking" type="strong"/></row-col>
                            <row-col sm="3"><label text="${packageRouteSeg?.returnTrackingCode?:'N/A'}"/></row-col>
                        </container-row>
                        <container-row>
                            <row-col sm="1"><label text="Ret Label" type="strong"/></row-col>
                            <row-col sm="3"><label text="${packageRouteSeg?.returnGatewayLabelId?:'N/A'}"/></row-col>
                            <row-col sm="1"><label text="Ret Amount" type="strong"/></row-col>
                            <row-col sm="3"><label text="${ec.l10n.format(packageRouteSeg?.returnEstimatedAmount, '#,##0.00')}" style="text-success"/></row-col>
                        </container-row>
                    </widgets></section>
                </box-body><box-body-nopad>
                    <form-list name="ShipmentPackageContentList" list="shipmentPackageContentList" transition="updatePackageContent">
                        <field name="shipmentId"><default-field><hidden/></default-field></field>
                        <field name="shipmentPackageSeqId"><default-field><hidden/></default-field></field>
                        <field name="productId"><default-field title="Product">
                            <display-entity entity-name="mantle.product.Product" text="ProductNameTemplate"/>
                        </default-field></field>
                        <field name="quantity"><default-field><text-line size="6"/></default-field></field>
                        <field name="submitButton"><default-field title="Update"><submit/></default-field></field>
                    </form-list>
                </box-body-nopad></container-box>
            </widgets></section-iterate>
        </row-col><row-col md="6">
            <!-- product/item list -->
            <!-- pack/issue form -->
            <!-- unpack button -->
            <section-iterate name="ShipmentItemsSection" list="shipmentItemDetailList" entry="sid"><actions>
                <if condition="isOutgoing || isTransfer">
                    <set field="quantityPackRemaining" from="sid.quantity - (sid.quantityTotal ?: 0)"/>
                    <entity-find entity-name="mantle.product.issuance.AssetAndIssuance" list="assetIssuanceList">
                        <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
                </if>
                <set field="allowPack" from="(isOutgoing || isTransfer) &amp;&amp; shipment.statusId in ['ShipInput', 'ShipScheduled', 'ShipPicked'] &amp;&amp; quantityPackRemaining &gt; 0"/>

                <entity-find-one entity-name="moqui.basic.Uom" value-field="productUom">
                    <field-map field-name="uomId" from="sid.amountUomId"/></entity-find-one>
                <entity-find entity-name="mantle.shipment.ShipmentItemSource" list="sisList">
                    <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
                <entity-find-one entity-name="mantle.product.Product" value-field="product">
                    <field-map field-name="productId" from="sid.productId"/></entity-find-one>

                <entity-find entity-name="mantle.shipment.ShipmentPackageContent" list="packageContentList">
                    <econdition field-name="shipmentId"/><econdition field-name="productId" from="sid.productId"/></entity-find>
                <set field="packageContentTotal" from="(packageContentList*.quantity).sum() ?: 0.0"/>
                <set field="quantityNotInPackage" from="((BigDecimal) sid.quantity ?: 0.0) - packageContentTotal"/>
            </actions><widgets>
                <container-box type="info"><box-header title="${ec.resource.expand('ProductNameTemplate', '', sid)} (Qty ${ec.l10n.format(sid.quantity ?: 0, '#.##')})"/><box-toolbar>
                    <section name="PackItemSection" condition="allowPack"><widgets>
                        <container-dialog id="PackItemContainer" button-text="Pack/Issue Item" type="success">
                            <form-single name="PackItemForm" transition="packShipmentProduct" map="sid">
                                <field name="shipmentId"><default-field><hidden/></default-field></field>
                                <field name="productId"><default-field title="Product">
                                    <display-entity entity-name="mantle.product.Product" text="ProductNameTemplate"/></default-field></field>
                                <field name="shipmentPackageSeqId"><default-field title="Package"><drop-down>
                                    <option key="" text="New Package"/>
                                    <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                                </drop-down></default-field></field>
                                <field name="quantity" from="quantityPackRemaining">
                                    <default-field><text-line size="8"/></default-field></field>
                                <field name="packDate" from="shipment.estimatedShipDate ?: ec.user.nowTimestamp">
                                    <default-field title="Pack Date"><date-time/></default-field></field>
                                <field name="assetId"><default-field title="Asset">
                                    <drop-down><dynamic-options transition="getAssetList" server-search="true" min-length="0"
                                            parameter-map="[facilityId:firstRouteSegment.originFacilityId, productId:productId, assetTypeEnumId:null, excludeZeroQoh:'true']"/></drop-down>
                                </default-field></field>
                                <field name="submitButton"><default-field title="Pack Quantity"><submit/></default-field></field>
                            </form-single>
                        </container-dialog>
                    </widgets></section>
                </box-toolbar><box-body>
                    <label condition="isOutgoing || isTransfer" text="Packed/Issued: ${ec.l10n.format(sid.quantityTotal ?: 0, '#.##')}, Remaining: ${ec.l10n.format(quantityPackRemaining, '#.##')}  (Unit: ${productUom?.description ?: 'N/A'})" type="div"/>
                    <container-row>
                        <row-col lg="5">
                            <section name="ShipItemUpdateSection" condition="allowUpdate"><widgets>
                                <form-single name="UpdateItemForm" transition="updateItem" map="sid">
                                    <field name="shipmentId"><default-field><hidden/></default-field></field>
                                    <field name="productId"><default-field><hidden/></default-field></field>
                                    <field name="quantity"><default-field title=""><text-line size="6"/></default-field></field>
                                    <field name="submitButton"><default-field title="Update Quantity"><submit/></default-field></field>
                                    <field-layout><field-row-big><field-ref name="quantity"/><field-ref name="submitButton"/></field-row-big></field-layout>
                                </form-single>
                            </widgets></section>
                        </row-col>
                        <row-col lg="7">
                            <section name="ShipItemPackageSection"><widgets>
                                <form-single name="AddItemToPackageForm" transition="addItemToPackage" map="sid">
                                    <field name="shipmentId"><default-field><hidden/></default-field></field>
                                    <field name="productId"><default-field><hidden/></default-field></field>
                                    <field name="shipmentPackageSeqId"><default-field title=""><drop-down>
                                        <option key="" text="New"/>
                                        <list-options list="shipmentPackageList" key="${shipmentPackageSeqId}" text="${shipmentPackageSeqId}"/>
                                    </drop-down></default-field></field>
                                    <field name="quantity" from="quantityNotInPackage"><default-field title="">
                                        <text-line size="6"/></default-field></field>
                                    <field name="submitButton"><default-field title="Add To Package"><submit/></default-field></field>
                                    <field-layout><field-row-big><field-ref name="shipmentPackageSeqId"/>
                                        <field-ref name="quantity"/><field-ref name="submitButton"/></field-row-big></field-layout>
                                </form-single>
                            </widgets></section>
                        </row-col>
                    </container-row>
                </box-body><box-body-nopad>
                    <!-- Pack and Issuance -->
                    <section name="ItemAssetPackSection" condition="isOutgoing || isTransfer"><widgets>
                        <form-list name="ItemSourceIssuanceList" list="sisList" skip-form="true">
                            <row-actions>
                                <entity-find entity-name="mantle.product.issuance.AssetReservation" list="existingResList">
                                    <econdition field-name="orderId"/><econdition field-name="orderItemSeqId"/></entity-find>
                                <set field="resPackForm" from="allowPack &amp;&amp; quantityNotHandled &gt; 0.0 &amp;&amp; existingResList"/>
                            </row-actions>
                            <field name="shipmentId"><default-field><hidden/></default-field></field>
                            <field name="shipmentItemSourceId"><default-field><hidden/></default-field></field>
                            <field name="orderId"><default-field title="Order">
                                <link url="orderDetail" text="${orderId?:''}" link-type="anchor"/></default-field></field>
                            <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>

                            <field name="quantitySis" from="quantity">
                                <default-field title="Quantity"><display/></default-field></field>
                            <field name="quantityNotHandled"><default-field title="Not Issued"><display/></default-field></field>

                            <field name="invoiceId"><default-field title="Invoice Item">
                                <link url="editInvoice" text="${invoiceId?:''}:${invoiceItemSeqId?:''}" link-type="anchor"/></default-field></field>

                            <field name="assetReservations">
                                <conditional-field condition="existingResList">
                                    <section-iterate name="ReservationInfoSection" list="existingResList" entry="existingRes"><actions>
                                        <entity-find-one entity-name="mantle.product.asset.AssetLotAndMfgParty" value-field="assetLot">
                                            <field-map field-name="assetId" from="existingRes.assetId"/></entity-find-one>
                                    </actions><widgets>
                                        <container>
                                            <label text="Res: ${ec.l10n.format(existingRes.quantity, null)}, Not Avail: ${ec.l10n.format(existingRes.quantityNotAvailable, null)}, Not Issued: ${ec.l10n.format(existingRes.quantityNotIssued, null)}" type="span"/>
                                            <link url="assetDetail" text="Asset ${existingRes.assetId}" parameter-map="[assetId:existingRes.assetId]" link-type="anchor"/>
                                        </container>
                                        <label text="LotNameTemplate" text-map="assetLot" condition="assetLot?.lotId"/>
                                    </widgets></section-iterate>
                                </conditional-field>
                                <default-field><display text=" "/></default-field>
                            </field>
                        </form-list>
                        <form-list name="ItemAssetIssuanceList" list="assetIssuanceList" skip-form="true">
                            <row-actions>
                                <entity-find-one entity-name="mantle.facility.FacilityLocation" value-field="facLoc"/>
                                <entity-find-one entity-name="mantle.product.issuance.AssetReservation" value-field="res"/>
                                <filter-map-list list="acctgTransList" to-list="issAcctgTransList">
                                    <field-map field-name="assetIssuanceId"/></filter-map-list>
                            </row-actions>
                            <field name="issuedDate"><default-field title="Issued Date"><display/></default-field></field>
                            <field name="quantity"><default-field title="Quantity"><display/></default-field></field>

                            <field name="assetId"><default-field><link url="assetDetail" text="${assetId}" link-type="anchor"/></default-field></field>
                            <field name="assetReservationId">
                                <conditional-field condition="res">
                                    <display text="${assetReservationId} - Res: ${ec.l10n.format(res.quantity, null)}, Not Avail: ${ec.l10n.format(res.quantityNotAvailable, null)}, Not Issued: ${ec.l10n.format(res.quantityNotIssued, null)}"/>
                                </conditional-field>
                                <default-field title="Reservation"><display/></default-field>
                            </field>

                            <field name="orderId"><default-field title="Order"><link url="orderDetail" text="${orderId}" link-type="anchor"/></default-field></field>
                            <field name="orderItemSeqId"><default-field title="Item"><display/></default-field></field>
                            <field name="acctgTransList"><default-field title="TX">
                                <section-iterate name="IssAcctgTransList" list="issAcctgTransList" entry="issAcctgTrans"><widgets>
                                    <link url="editTransaction" text="${issAcctgTrans.acctgTransId}" link-type="anchor"
                                            parameter-map="[acctgTransId:issAcctgTrans.acctgTransId]"/>
                                </widgets></section-iterate>
                            </default-field></field>
                            <field name="locationSeqId"><default-field title="Was Stored At">
                                <display text="FacilityLocationNameTemplate" text-map="facLoc?:[:]"/></default-field></field>
                            <field name="lotId"><default-field title="Lot">
                                <display-entity entity-name="mantle.product.asset.LotAndMfgParty" text="LotNameTemplate"/></default-field></field>
                            <field name="unpackLink"><default-field title=""><link url="unpackItemIssuance" text="Unpack"
                                    parameter-map="[shipmentId:shipmentId, assetIssuanceId:assetIssuanceId]"
                                    condition="!invoiceId &amp;&amp; quantity"
                                    confirmation="Are you sure? Only do this when necessary to avoid processing a return to receive the item back into inventory."/>
                            </default-field></field>
                        </form-list>
                    </widgets></section>
                </box-body-nopad></container-box>
            </widgets></section-iterate>

            <!-- shipment info like address, etc -->
            <container type="dl" style="dl-horizontal">
                <label text="To" type="dt" condition="isOutgoing"/>
                <label text="${toPartyDetail ? ec.resource.expand('PartyNameTemplate', '', toPartyDetail) : 'Not Set'}" type="dd" condition="isOutgoing"/>
                <label text="Origin Facility" type="dt" condition="isOutgoing || isTransfer"/>
                <label text="${ec.resource.expand('FacilityNameTemplate', '', originFacility)}" type="dd" condition="isOutgoing || isTransfer"/>
                <label text="Destination Facility" type="dt" condition="isIncoming || isTransfer"/>
                <label text="${ec.resource.expand('FacilityNameTemplate', '', destinationFacility)}" type="dd" condition="isIncoming || isTransfer"/>

                <label text="Shipment Type" type="dt"/><label text="${shipmentTypeEnum?.description}" type="dd"/>
                <label text="Status" type="dt"/><label text="${statusItem.description}" type="dd"/>
                <label text="Estimated Ready" type="dt" condition="isOutgoing || isTransfer"/>
                <label text="${ec.l10n.format(shipment.estimatedReadyDate, 'yyyy-MM-dd HH:mm') ?: 'Not Set'}" type="dd" condition="isOutgoing || isTransfer"/>
                <label text="Estimated Arrival" type="dt"/><label text="${ec.l10n.format(shipment.estimatedArrivalDate, 'yyyy-MM-dd HH:mm') ?: 'Not Set'}" type="dd"/>

                <label text="Ship By" type="dt"/><label text="${curCarrierShipmentMethod?.description ? curCarrierShipmentMethod?.description : (curCarrierDetail ? curCarrierDetail.pseudoId : 'N/A') + (curShipmentMethodEnum ? curShipmentMethodEnum.description : 'None')}" type="dd"/>
                <label text="Shipping Instructions" type="dt" condition="shipment.handlingInstructions"/>
                <label text="${shipment.handlingInstructions}" type="dd" condition="shipment.handlingInstructions"/>
                <section name="ShippedShippingInfo" condition="curPaInfo"><actions><set field="contactInfo" from="curPaInfo"/></actions><widgets>
                    <label text="Destination" type="dt"/>
                    <container type="dd">
                        <render-mode><text type="html,vuet" location="component://SimpleScreens/template/party/ContactInfo.html.gstring"/></render-mode>
                        <container><label text="Trust: ${contactInfo.postalTrustLevelEnum?.description ?: 'New'}" type="strong"/></container>
                        <label text="${contactInfo.postalContactMech.validateMessage?:''}" type="div"/>
                    </container>
                </widgets></section>
            </container>
        </row-col></container-row>
    </widgets>
</screen>
